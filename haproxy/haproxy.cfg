global
    log stdout format raw local0
    maxconn 4096
    daemon

defaults
    log     global
    mode    tcp
    option  dontlognull
    timeout connect 10s
    timeout client  1m
    timeout server  1m

# --- Write traffic: route to current leader ---
frontend postgres_write
    bind *:5000
    default_backend patroni_leader

backend patroni_leader
    option httpchk GET /master
    http-check expect status 200
    mode tcp
    balance roundrobin

    server patroni-1 patroni-1.internal:5432 check port 8008
    server patroni-2 patroni-2.internal:5432 check port 8008
    server patroni-3 patroni-3.internal:5432 check port 8008

# --- Optional read-only endpoint ---
frontend postgres_read
    bind *:5001
    default_backend patroni_replicas

backend patroni_replicas
    option httpchk GET /replica
    http-check expect status 200
    mode tcp
    balance roundrobin

    server patroni-1 patroni-1.internal:5432 check port 8008
    server patroni-2 patroni-2.internal:5432 check port 8008
    server patroni-3 patroni-3.internal:5432 check port 8008
